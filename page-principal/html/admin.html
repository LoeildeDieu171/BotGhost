<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel ‚Ä¢ Dashboard</title>
  <link rel="stylesheet" href="/page-principal/css/accueil.css">
  <link rel="stylesheet" href="/page-principal/css/admin.css">
  <script src="/page-principal/js/dashboard.js" defer></script>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div>
      <div class="logo-section" onclick="navigateTo('accueil')" style="cursor: pointer;">
        <img src="/logo.png" alt="Logo" class="sidebar-logo">
      </div>

      <nav class="menu">
        <a class="item" onclick="navigateTo('accueil')">Accueil</a>
        <a class="item" onclick="navigateTo('profil')">Mon Profil</a>
        <a class="item" onclick="navigateTo('candidatures')">Mes Candidatures</a>
        <a class="item" onclick="navigateTo('recrutement')">Recrutement</a>
      </nav>

      <div class="admin-section">
        <div class="admin-divider"></div>
        <a class="item active" onclick="navigateTo('admin')">Admin Panel</a>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="bug-btn" onclick="location.href='/bug/bug.html'">
        Signaler un bug
      </button>

      <button class="logout-btn" onclick="logout()">
        D√©connexion
      </button>

      <div class="user" onclick="navigateTo('profil')" style="cursor: pointer;">
        <img id="userAvatar" src="/logo.png" alt="avatar">
        <div>
          <strong id="userName">Utilisateur</strong><br>
          <small>Membre</small>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- HEADER -->
    <header class="header">
      <div class="welcome">
        <h2>Panel Administrateur</h2>
        <p>Gestion compl√®te du site</p>
      </div>
    </header>

    <section class="content">

      <!-- ADMIN STATS -->
      <div class="admin-stats">
        <div class="admin-stat">
          <span>Utilisateurs</span>
          <strong id="statUsers">0</strong>
        </div>
        <div class="admin-stat">
          <span>Candidatures</span>
          <strong id="statCandidatures">0</strong>
        </div>
        <div class="admin-stat">
          <span>Bugs Signal√©s</span>
          <strong id="statBugs">0</strong>
        </div>
        <div class="admin-stat">
          <span>Postes Ouverts</span>
          <strong id="statJobs">3</strong>
        </div>
      </div>

      <!-- TABS -->
      <div class="admin-tabs">
        <button class="tab-btn active" data-tab="bugs">Bugs Signal√©s</button>
        <button class="tab-btn" data-tab="candidatures">Candidatures</button>
        <button class="tab-btn" data-tab="users">Utilisateurs</button>
      </div>

      <!-- BUGS TAB -->
      <div id="tab-bugs" class="tab-content active">
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Priorit√©</th>
                <th>Utilisateur</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="bugsList">
              <tr>
                <td colspan="5" class="empty">Aucun bug signal√©</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CANDIDATURES TAB -->
      <div id="tab-candidatures" class="tab-content">
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Utilisateur</th>
                <th>Poste</th>
                <th>Statut</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="candidaturesList">
              <tr>
                <td colspan="5" class="empty">Aucune candidature</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- USERS TAB -->
      <div id="tab-users" class="tab-content">
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>R√¥le</th>
                <th>Candidatures</th>
                <th>Rejoign√©</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="usersList">
              <tr>
                <td colspan="5" class="empty">Aucun utilisateur</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </section>

  </main>

</div>

<script>
  // Navigation
  function navigateTo(page) {
    const pages = {
      'accueil': '/page-principal/html/accueil.html',
      'profil': '/page-principal/html/profil.html',
      'candidatures': '/page-principal/html/candidatures.html',
      'recrutement': '/page-principal/html/recrutement.html',
      'admin': '/page-principal/html/admin.html'
    };
    if (pages[page]) {
      window.location.href = pages[page];
    }
  }

  // D√©connexion
  function logout() {
    fetch('/logout', { method: 'POST' })
      .then(() => {
        window.location.href = '/';
      })
      .catch(err => {
        console.error('Erreur d√©connexion:', err);
        window.location.href = '/';
      });
  }

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabName = e.target.dataset.tab;
      
      // Remove active class
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Add active class
      e.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    });
  });

  // Load data
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/user')
      .then(res => res.json())
      .then(data => {
        if (data.user) {
          document.getElementById('userName').textContent = data.user.username;
          if (data.user.avatar) {
            document.getElementById('userAvatar').src = data.user.avatar;
          }

          // V√©rifier si admin
          if (data.user.role !== 'owner') {
            window.location.href = '/page-principal/html/accueil.html';
          }

          loadAdminData();
        } else {
          window.location.href = '/';
        }
      })
      .catch(err => console.log('Erreur:', err));
  });

  function loadAdminData() {
    // Charger les statistiques et donn√©es
    fetch('/api/admin/stats')
      .then(res => res.json())
      .then(data => {
        document.getElementById('statUsers').textContent = data.users || 0;
        document.getElementById('statCandidatures').textContent = data.candidatures || 0;
        document.getElementById('statBugs').textContent = data.bugs || 0;
      })
      .catch(err => console.log('Erreur stats:', err));

    // Charger les bugs
    fetch('/api/admin/bugs')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('bugsList');
        if (data.bugs && data.bugs.length > 0) {
          tbody.innerHTML = data.bugs.map(bug => `
            <tr>
              <td>${bug.title}</td>
              <td><span class="priority-${(bug.priority||'Moyen').toLowerCase()}">${bug.priority || 'Moyen'}</span></td>
              <td>${bug.username}</td>
              <td>${new Date(bug.date).toLocaleDateString('fr-FR')}</td>
              <td>
                <button class="btn-small" onclick="viewBug('${bug.id}')">Voir</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">Aucun bug signal√©</td></tr>';
        }
      })
      .catch(err => console.log('Erreur bugs:', err));

    // Charger les candidatures
    fetch('/api/admin/candidatures')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('candidaturesList');
        if (data.candidatures && data.candidatures.length > 0) {
          tbody.innerHTML = data.candidatures.map(c => `
            <tr>
              <td>${c.username}</td>
              <td>${c.jobTitle}</td>
              <td>${c.statusLabel || c.status}</td>
              <td>${new Date(c.date).toLocaleDateString('fr-FR')}</td>
              <td>
                <button class="btn-small" onclick="viewCandidature('${c.id}')">Voir</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">Aucune candidature</td></tr>';
        }
      })
      .catch(err => console.log('Erreur candidatures:', err));

    // Charger utilisateurs
    fetch('/api/admin/users')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('usersList');
        if (data.users && data.users.length > 0) {
          tbody.innerHTML = data.users.map(u => `
            <tr>
              <td>${u.username}</td>
              <td>${u.role || 'member'}</td>
              <td>${u.candidatures || 0}</td>
              <td>${u.online ? 'En ligne' : (u.last_seen ? new Date(u.last_seen).toLocaleString('fr-FR') : '‚Äî')}</td>
              <td><button class="btn-small danger" onclick="expelUser('${u.discordId || u.discord_id || u.id}')">Expulser</button></td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">Aucun utilisateur</td></tr>';
        }
      })
      .catch(err => console.log('Erreur users:', err));
  }

  function deleteBug(id) {
    if (!confirm('Supprimer ce rapport de bug ?')) return;
    fetch('/api/admin/bugs/' + id, { method: 'DELETE' })
      .then(r => r.json())
      .then(() => {
        alert('Bug supprim√©');
        loadAdminData();
      })
      .catch(err => console.error(err));
  }

  function adminActionCandidature(id, action) {
    if (!confirm(`Confirmer: ${action} ?`)) return;
    fetch('/api/admin/candidatures/' + id, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action })
    })
      .then(r => r.json())
      .then(() => loadAdminData())
      .catch(err => console.error(err));
  }

  function expelUser(userId) {
    const reason = prompt('Raison de l\'expulsion (optionnel):');
    if (!userId) return;
    fetch('/api/admin/expel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, reason })
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          alert('Utilisateur expuls√© et banni');
          loadAdminData();
        } else {
          alert('Erreur: ' + (data.message || 'Impossible d\'expulser'));
        }
      })
      .catch(err => {
        console.error(err);
        alert('Erreur lors de l\'expulsion');
      });
  }

  function viewBug(id) {
    // Fetch bug details and show modal
    fetch('/api/admin/bugs')
      .then(r => r.json())
      .then(data => {
        const bug = data.bugs.find(b => b.id === id);
        if (!bug) {
          alert('Bug non trouv√©');
          return;
        }
        showBugModal(bug);
      })
      .catch(err => console.error(err));
  }

  function showBugModal(bug) {
    const existing = document.getElementById('bugDetailsModal');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.id = 'bugDetailsModal';
    modal.className = 'modal-backdrop';
    modal.innerHTML = `
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>${bug.title}</h3>
          <button class="close-btn" onclick="document.getElementById('bugDetailsModal').remove()">‚úï</button>
        </div>
        <div class="modal-content">
          <div class="detail-row">
            <strong>Description</strong>
            <p>${bug.description}</p>
          </div>
          <div class="detail-row">
            <strong>Page</strong>
            <p>${bug.page}</p>
          </div>
          <div class="detail-row">
            <strong>Priorit√©</strong>
            <p><span class="priority-${(bug.priority||'Moyen').toLowerCase()}">${bug.priority || 'Moyen'}</span></p>
          </div>
          <div class="detail-row">
            <strong>Signal√© par</strong>
            <p>${bug.username}</p>
          </div>
          <div class="detail-row">
            <strong>Date</strong>
            <p>${new Date(bug.date).toLocaleString('fr-FR')}</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="danger" onclick="deleteBug('${bug.id}'); document.getElementById('bugDetailsModal').remove();">Supprimer</button>
          <button onclick="document.getElementById('bugDetailsModal').remove()">Fermer</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', () => modal.remove());
  }

  function viewCandidature(id) {
    // Fetch candidature details and show modal
    fetch('/api/admin/candidatures')
      .then(r => r.json())
      .then(data => {
        const cand = data.candidatures.find(c => c.id === id);
        if (!cand) {
          alert('Candidature non trouv√©e');
          return;
        }
        showCandidatureModal(cand);
      })
      .catch(err => console.error(err));
  }

  function showCandidatureModal(cand) {
    const existing = document.getElementById('candDetailsModal');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.id = 'candDetailsModal';
    modal.className = 'modal-backdrop';
    modal.innerHTML = `
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3>Candidature ‚Äî ${cand.jobTitle}</h3>
          <button class="close-btn" onclick="document.getElementById('candDetailsModal').remove()">‚úï</button>
        </div>
        <div class="modal-content">
          <div class="detail-row">
            <strong>Candidat</strong>
            <p>${cand.username}</p>
          </div>
          <div class="detail-row">
            <strong>Poste</strong>
            <p>${cand.jobTitle}</p>
          </div>
          <div class="detail-row">
            <strong>Statut</strong>
            <p>${cand.statusLabel || cand.status}</p>
          </div>
          <div class="detail-row">
            <strong>√Çge</strong>
            <p>${cand.age || '‚Äî'}</p>
          </div>
          <div class="detail-row">
            <strong>Exp√©rience</strong>
            <p>${cand.experience ? cand.experience + ' ans' : '‚Äî'}</p>
          </div>
          <div class="detail-row">
            <strong>Disponibilit√©s</strong>
            <p>${cand.availability || '‚Äî'}</p>
          </div>
          <div class="detail-row">
            <strong>Motivation</strong>
            <p>${cand.extra || '‚Äî'}</p>
          </div>
          <div class="detail-row">
            <strong>Date de candidature</strong>
            <p>${new Date(cand.date).toLocaleString('fr-FR')}</p>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="adminActionCandidature('${cand.id}','accept'); document.getElementById('candDetailsModal').remove();">‚úì Accepter</button>
          <button onclick="adminActionCandidature('${cand.id}','refuse'); document.getElementById('candDetailsModal').remove();">‚úó Refuser</button>
          <button class="danger" onclick="adminActionCandidature('${cand.id}','delete'); document.getElementById('candDetailsModal').remove();">üóëÔ∏è Supprimer</button>
          <button onclick="document.getElementById('candDetailsModal').remove()">Fermer</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', () => modal.remove());
  }
</script>

</body>
</html>